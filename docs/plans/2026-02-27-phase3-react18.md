# Phase 3 — React 17→18

**Date**: 2026-02-27
**Status**: Ready for implementation
**Effort**: M (1-2 sessions with Claude)
**Prerequisite**: Jest 29 (from Phase 1 Node 22 upgrade)

## Migration Map

### Priority 1 — 3 Bridge Files (fix once, propagate to 40+ consumers)

These 3 files are the backbone of the React rendering system. Fixing them cascades to all ReactController and ReactView subclasses.

#### Bridge 1: `reactElementHelper.ts`
**Path**: `src/Akeneo/Platform/Bundle/UIBundle/Resources/workspaces/legacy-bridge/src/bridge/react/reactElementHelper.ts`
- Line 4: `ReactDOM.render(component, container)`
- Line 10: `ReactDOM.unmountComponentAtNode(container)`
- **Consumers**: 14 ReactControllers + 8 ReactViews (all routes)

```typescript
// Before
export const mountReactElementRef = (component: ReactElement, container: Element) => {
  ReactDOM.render(component, container);
};
export const unmountReactElementRef = (container: Element) => {
  ReactDOM.unmountComponentAtNode(container);
};

// After
import { createRoot, Root } from 'react-dom/client';
const roots = new WeakMap<Element, Root>();

export const mountReactElementRef = (component: ReactElement, container: Element) => {
  let root = roots.get(container);
  if (!root) {
    root = createRoot(container);
    roots.set(container, root);
  }
  root.render(component);
};
export const unmountReactElementRef = (container: Element) => {
  const root = roots.get(container);
  if (root) {
    root.unmount();
    roots.delete(container);
  }
};
```

#### Bridge 2: Connectivity `react-element-helper.ts`
**Path**: `src/Akeneo/Connectivity/Connection/back/Infrastructure/Symfony/Resources/public/js/react/react-element-helper.ts`
- Line 8: `ReactDOM.render(component, container)`
- Line 16: `ReactDOM.unmountComponentAtNode(container)`
- Module-level singleton container

Same pattern as Bridge 1. Store `Root` instead of `Element`.

#### Bridge 3: Backbone base view `base.ts`
**Path**: `src/Akeneo/Platform/Bundle/UIBundle/Resources/public/js/view/base.ts`
- Line 260-267: `ReactDOM.render(...)` in `renderReact()`
- Line 275: `ReactDOM.unmountComponentAtNode(this.reactRef)` in `unmountReact()`

Store `this.reactRoot` on the view instance.

### Priority 2 — 26 Direct Render Calls

Each is a standalone fix. Grouped by bounded context:

**Platform/UIBundle** (13 files):
| File | Line | Context |
|------|------|---------|
| `js/messenger.tsx` | 11 | Notification messages |
| `js/TreeView.tsx` | 136 | Tree widget |
| `js/TreeAssociate.tsx` | 156 | Product tree association |
| `js/mass-edit/form/choose.tsx` | 35 | Mass edit chooser |
| `js/form/common/attributes/create-button.tsx` | 54 | Attribute create button |
| `js/filter/product/category/Selector.tsx` | 148 | Category filter |
| `js/datagrid/reactCell.tsx` | 39 | Datagrid React cell |
| `js/product/form/locale-switcher.tsx` | 82 | Locale switcher |
| `js/product/field/boolean-field.tsx` | 21 | Boolean field |
| `js/product/grid/locale-switcher.tsx` | 39 | Grid locale switcher |
| `js/attribute/form/choices.tsx` | 39 | Attribute choices |
| `js/attribute/form/properties/guidelines.tsx` | 20 | Guidelines field |
| `js/datagrid/action/delete-attribute-action.tsx` | 27 | Delete attribute dialog |

**Pim/Structure** (1 file):
| File | Line |
|------|------|
| `attribute/form/attribute-setup.tsx` | 31 |

**DataQualityInsights** (5 files):
| File | Line |
|------|------|
| `datagrid/cell/quality-score-badge-cell.tsx` | 20 |
| `dqi-dashboard/section.tsx` | 13 |
| `attribute-group/dqi-activation.tsx` | 9 |
| `pim-view/back-link.tsx` | 33 |
| `product-edit-form/data-quality-insights-app.tsx` | 196 |

**Oro/PimDataGridBundle** (2 files):
| File | Line |
|------|------|
| `datagrid/action/attribute-mass-delete-action.ts` | 74 |
| `datagrid/ProductGalleryRow.tsx` | 97 |

**UserManagement** (1 file):
| File | Line |
|------|------|
| `datagrid/action/duplicate-user-action.tsx` | 25 |

### Priority 3 — 6 App Entry Points

These `index.tsx` files use `ReactDOM.render(<StrictMode>...)`:

| File |
|------|
| `src/Akeneo/Category/front/src/index.tsx` |
| `src/Oro/Bundle/ConfigBundle/front/src/index.tsx` |
| `src/Akeneo/Tool/Bundle/MeasureBundle/front/src/index.tsx` |
| `src/Akeneo/Platform/Bundle/CatalogVolumeMonitoringBundle/front/src/index.tsx` |
| `src/Akeneo/Platform/Job/front/process-tracker/src/index.tsx` |
| `components/identifier-generator/front/src/index.tsx` |

**Note**: React 18 StrictMode double-invokes effects in dev mode. These entry points already use StrictMode — verify no side effects break.

### Priority 4 — Testing Library Migration (104 files)

#### Import Changes

All 104 files change:
```typescript
// Before
import { renderHook, act } from '@testing-library/react-hooks';

// After
import { renderHook, act } from '@testing-library/react';
```

#### Test Utility Files

2 shared test utilities also need `createRoot` migration:
- `front-packages/shared/src/tests/utils.tsx:19` — `renderDOMWithProviders` uses `ReactDOM.render`
- `src/Akeneo/Platform/Bundle/UIBundle/Resources/workspaces/legacy-bridge/tests/front/unit/utils.tsx:19`

#### Package Version Changes

| Package | Current | Target | Notes |
|---------|---------|--------|-------|
| `react` | `^17.0.2` | `^18.0.0` | All 10+ workspace packages |
| `react-dom` | `^17.0.2` | `^18.0.0` | All 10+ workspace packages |
| `@types/react` | `^17.0.2` | `^18.0.0` | |
| `@types/react-dom` | `^17.0.2` | `^18.0.0` | |
| `@testing-library/react` | `^11.2.6` | `^14.0.0` | v13+ supports React 18 |
| `@testing-library/react-hooks` | `^3.4.2` | **remove** | Merged into RTL v13 |
| `@testing-library/user-event` | `^12.8.3` | `^14.0.0` | Breaking: `userEvent.setup()` API |
| `react-test-renderer` | `^16.8.0` | `^18.0.0` | Currently mismatched (v16 vs React 17!) |
| `jest-environment-jsdom` | (bundled) | `^29.7.0` | Separate package since Jest 27 |

#### `@testing-library/user-event` v12→v14 Breaking Change

v14 requires `userEvent.setup()` instead of direct calls:
```typescript
// Before (v12)
userEvent.click(button);
userEvent.type(input, 'hello');

// After (v14)
const user = userEvent.setup();
await user.click(button);
await user.type(input, 'hello');
```

### Not Affected (safe)

- ✅ 5 class components — all ErrorBoundary with `getDerivedStateFromError` (works in React 18)
- ✅ 0 `ReactDOM.hydrate()` — no SSR
- ✅ 0 `ReactDOM.findDOMNode()` — not used
- ✅ 0 `React.createFactory()` — not used
- ✅ 0 string refs — all callback or `createRef`
- ✅ 0 legacy context API — no `childContextTypes`

## StrictMode Inventory

15 files use `<StrictMode>`. React 18 StrictMode double-invokes:
- `useState` initializer
- `useEffect` / `useLayoutEffect` (mount → unmount → mount)
- `useMemo` / `useReducer`

This catches impure effects. Main risk: API calls in effects may fire twice in dev mode. Production is unaffected.

## Migration Steps

### Step 1: Package updates
```bash
yarn add react@18 react-dom@18 @types/react@18 @types/react-dom@18
yarn add -D @testing-library/react@14 @testing-library/user-event@14 react-test-renderer@18 jest-environment-jsdom@29
yarn remove @testing-library/react-hooks
```

Update all workspace `package.json` files (10+ packages).

### Step 2: Bridge files (3 files → fixes 40+ consumers)

### Step 3: Direct render calls (26 files)

### Step 4: Entry points (6 files)

### Step 5: Test utilities (2 files) + import changes (104 files)

### Step 6: Validate
```bash
yarn lint
yarn unit
npx playwright test
```
