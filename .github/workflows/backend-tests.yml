name: Backend Tests (PHP 8.2)

on:
  push:
    branches: [ master ]
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'components/**'
      - 'upgrades/**'
      - 'composer.*'
      - 'Makefile'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - 'config/**'
      - '.github/workflows/backend-tests.yml'

jobs:
  php-tests:
    runs-on: ubuntu-latest
    env:
      APP_ENV: test
      APP_DEBUG: 1
    services:
      mysql:
        image: mysql:8.0.30
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: akeneo_pim_test
          MYSQL_USER: akeneo_pim
          MYSQL_PASSWORD: akeneo_pim
        ports: ['3306:3306']
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      elasticsearch:
        image: elastic/elasticsearch:8.11.4
        env:
          discovery.type: single-node
          xpack.security.enabled: 'false'
          indices.id_field_data.enabled: 'true'
        ports: ['9200:9200']
        options: >-
          --health-cmd="curl -s http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=50s || exit 1"
          --health-interval=15s
          --health-timeout=10s
          --health-retries=10
      minio:
        image: minio/minio:RELEASE.2021-09-15T04-54-25Z
        env:
          MINIO_ACCESS_KEY: AKENEO_OBJECT_STORAGE_ACCESS_KEY
          MINIO_SECRET_KEY: AKENEO_OBJECT_STORAGE_SECRET_KEY
        ports: ['9000:9000', '9091:9091']
        command: server --console-address :9091 /data
        options: --health-cmd="curl -f http://localhost:9000/minio/health/ready || exit 1" --health-interval=15s --health-timeout=5s --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql, zip, gd, imagick
          tools: composer:v2
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-interaction --no-progress

      - name: Warm test cache & DB
        run: |
          php bin/console doctrine:database:drop --force --if-exists || true
          php bin/console doctrine:database:create --if-not-exists
          php bin/console pim:installer:db

      - name: Run phpspec
        run: php vendor/bin/phpspec run --no-interaction

      - name: Run phpstan (level 2)
        run: php -d memory_limit=1G vendor/bin/phpstan analyse src/Akeneo/Pim --level 2

      - name: Lint container
        run: php bin/console lint:container

      - name: CS fixer (dry-run)
        run: php vendor/bin/php-cs-fixer fix --diff --dry-run --config=.php_cs.php

  phpunit:
    needs: php-tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - suite: Category
          - suite: PIM_Migration_Test
          - suite: PIM_Integration_Test
            paratest: true
            processes: 4
          - suite: Akeneo_Connectivity_Connection_Integration
          - suite: Akeneo_FileStorage_Integration
          - suite: Akeneo_Measurement_Integration
          - suite: Akeneo_Measurement_Acceptance
          - suite: Akeneo_Measurement_EndToEnd
          - suite: Akeneo_Connectivity_Connection_EndToEnd
          - suite: Akeneo_Communication_Channel_Integration
          - suite: Data_Quality_Insights
            paratest: true
            processes: 4
          - suite: Batch_Queue_Acceptance
          - suite: End_to_End
            paratest: true
            processes: 4
          - suite: Enrichment_Product
          - suite: Identifier_Generator_PhpUnit
          - suite: OroSecurityBundle
    env:
      APP_ENV: test
      APP_DEBUG: 1
    services:
      mysql:
        image: mysql:8.0.30
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: akeneo_pim_test
          MYSQL_USER: akeneo_pim
          MYSQL_PASSWORD: akeneo_pim
        ports: ['3306:3306']
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      elasticsearch:
        image: elastic/elasticsearch:8.11.4
        env:
          discovery.type: single-node
          xpack.security.enabled: 'false'
          indices.id_field_data.enabled: 'true'
        ports: ['9200:9200']
        options: >-
          --health-cmd="curl -s http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=50s || exit 1"
          --health-interval=15s
          --health-timeout=10s
          --health-retries=10
      minio:
        image: minio/minio:RELEASE.2021-09-15T04-54-25Z
        env:
          MINIO_ACCESS_KEY: AKENEO_OBJECT_STORAGE_ACCESS_KEY
          MINIO_SECRET_KEY: AKENEO_OBJECT_STORAGE_SECRET_KEY
        ports: ['9000:9000', '9091:9091']
        command: server --console-address :9091 /data
        options: --health-cmd="curl -f http://localhost:9000/minio/health/ready || exit 1" --health-interval=15s --health-timeout=5s --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql, zip, gd, imagick
          tools: composer:v2
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-interaction --no-progress

      - name: Warm test cache & DB
        run: |
          php bin/console doctrine:database:drop --force --if-exists || true
          php bin/console doctrine:database:create --if-not-exists
          php bin/console pim:installer:db

      - name: Run phpunit suite ${{ matrix.suite }}
        run: |
          mkdir -p var/tmp
          PARATEST="${{ matrix.paratest || 'false' }}"
          PROCS="${{ matrix.processes || 4 }}"
          if [ "$PARATEST" = "true" ]; then
            vendor/bin/paratest -c . --testsuite "${{ matrix.suite }}" --runner=WrapperRunner --processes="$PROCS" --passthru-php="-d memory_limit=1G" --cache-result-file=var/tmp/phpunit-${{ matrix.suite }}.cache
          else
            php -d memory_limit=1G vendor/bin/phpunit -c . --testsuite "${{ matrix.suite }}" --cache-result-file=var/tmp/phpunit-${{ matrix.suite }}.cache
          fi
